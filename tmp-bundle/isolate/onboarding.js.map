{
  "version": 3,
  "sources": ["../convex/onboarding.ts"],
  "sourcesContent": ["/**\r\n * Onboarding Functions\r\n *\r\n * Public and internal mutations/queries for onboarding step tracking\r\n */\r\n\r\nimport { v } from 'convex/values';\r\nimport { mutation, internalMutation, internalQuery } from './_generated/server';\r\nimport { auth } from './auth';\r\nimport { api } from './_generated/api';\r\n\r\n/**\r\n * Public mutation for frontend to update onboarding step\r\n */\r\nexport const updateOnboardingStep = mutation({\r\n  args: {\r\n    step: v.union(\r\n      v.literal('signupCompleted'),\r\n      v.literal('planSelected'),\r\n      v.literal('paymentCompleted'),\r\n      v.literal('projectCreated'),\r\n      v.literal('organizationCreated'),\r\n      v.literal('ga4Connected'),\r\n      v.literal('gscConnected')\r\n    ),\r\n    value: v.union(v.boolean(), v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const userId = await auth.getUserId(ctx);\r\n    if (!userId) throw new Error('Unauthorized');\r\n\r\n    const user = await ctx.db.get(userId);\r\n    if (!user) throw new Error('User not found');\r\n\r\n    const currentSteps = user.onboardingSteps || {};\r\n    const now = Date.now();\r\n\r\n    const updatedSteps: Record<string, any> = { ...currentSteps };\r\n    updatedSteps[args.step] = args.value;\r\n    updatedSteps[`${args.step}At`] = now;\r\n\r\n    // Auto-create organization when signup completes (if not already created)\r\n    if (args.step === 'signupCompleted' && args.value === true && !user.organizationId) {\r\n      // Create org using the teams module\r\n      const orgId = await ctx.runMutation(api.teams.teams.createOrganization, {});\r\n      updatedSteps['organizationCreated'] = true;\r\n      updatedSteps['organizationCreatedAt'] = now;\r\n    }\r\n\r\n    // Build patch object\r\n    const patchData: Record<string, any> = {\r\n      onboardingSteps: updatedSteps,\r\n      onboardingStatus: 'in_progress',\r\n      lastActiveAt: now,\r\n      updatedAt: now,\r\n    };\r\n\r\n    // When plan is selected, also update the user's membershipTier\r\n    if (args.step === 'planSelected' && typeof args.value === 'string') {\r\n      patchData.membershipTier = args.value;\r\n    }\r\n\r\n    await ctx.db.patch(userId, patchData);\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n\r\n/**\r\n * Update multiple onboarding steps in a SINGLE write to avoid write conflicts.\r\n * Use this when updating multiple steps in quick succession (e.g., payment + project).\r\n */\r\nexport const updateMultipleSteps = mutation({\r\n  args: {\r\n    steps: v.array(\r\n      v.object({\r\n        step: v.union(\r\n          v.literal('signupCompleted'),\r\n          v.literal('planSelected'),\r\n          v.literal('paymentCompleted'),\r\n          v.literal('projectCreated'),\r\n          v.literal('ga4Connected'),\r\n          v.literal('gscConnected')\r\n        ),\r\n        value: v.union(v.boolean(), v.string()),\r\n      })\r\n    ),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const userId = await auth.getUserId(ctx);\r\n    if (!userId) throw new Error('Unauthorized');\r\n\r\n    const user = await ctx.db.get(userId);\r\n    if (!user) throw new Error('User not found');\r\n\r\n    const now = Date.now();\r\n    const updatedSteps: Record<string, any> = { ...(user.onboardingSteps || {}) };\r\n\r\n    // Apply ALL steps in ONE write\r\n    for (const { step, value } of args.steps) {\r\n      updatedSteps[step] = value;\r\n      updatedSteps[`${step}At`] = now;\r\n    }\r\n\r\n    await ctx.db.patch(userId, {\r\n      onboardingSteps: updatedSteps,\r\n      onboardingStatus: 'in_progress',\r\n      lastActiveAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n\r\n/**\r\n * Update a specific onboarding step\r\n */\r\nexport const updateStep = internalMutation({\r\n  args: {\r\n    userId: v.id('users'),\r\n    step: v.union(\r\n      v.literal('signupCompleted'),\r\n      v.literal('planSelected'),\r\n      v.literal('paymentCompleted'),\r\n      v.literal('projectCreated'),\r\n      v.literal('ga4Connected'),\r\n      v.literal('gscConnected')\r\n    ),\r\n    value: v.union(v.boolean(), v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const user = await ctx.db.get(args.userId);\r\n    if (!user) throw new Error('User not found');\r\n\r\n    const currentSteps = user.onboardingSteps || {};\r\n    const now = Date.now();\r\n\r\n    // Build updated steps object\r\n    const updatedSteps: Record<string, any> = { ...currentSteps };\r\n    updatedSteps[args.step] = args.value;\r\n    updatedSteps[`${args.step}At`] = now;\r\n\r\n    await ctx.db.patch(args.userId, {\r\n      onboardingSteps: updatedSteps,\r\n      onboardingStatus: 'in_progress',\r\n      lastActiveAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n\r\n/**\r\n * Get onboarding progress for a user\r\n */\r\nexport const getProgress = internalQuery({\r\n  args: {\r\n    userId: v.id('users'),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const user = await ctx.db.get(args.userId);\r\n    if (!user) throw new Error('User not found');\r\n\r\n    const steps = (user.onboardingSteps || {}) as Record<\r\n      string,\r\n      boolean | string | number | undefined\r\n    >;\r\n\r\n    // Required steps to consider onboarding \"complete\"\r\n    const requiredSteps = ['signupCompleted', 'planSelected', 'paymentCompleted', 'projectCreated'];\r\n\r\n    // Optional steps (nice to have but not required)\r\n    const optionalSteps = ['ga4Connected', 'gscConnected'];\r\n\r\n    // Count completed required steps\r\n    const completedRequired = requiredSteps.filter(\r\n      (step) => steps[step] === true || (step === 'planSelected' && typeof steps[step] === 'string')\r\n    ).length;\r\n\r\n    // Count completed optional steps\r\n    const completedOptional = optionalSteps.filter((step) => steps[step] === true).length;\r\n\r\n    const totalSteps = requiredSteps.length + optionalSteps.length;\r\n    const completedSteps = completedRequired + completedOptional;\r\n    const isComplete = completedRequired === requiredSteps.length;\r\n\r\n    return {\r\n      steps,\r\n      completedSteps,\r\n      totalSteps,\r\n      completedRequired,\r\n      totalRequired: requiredSteps.length,\r\n      isComplete,\r\n      percentComplete: Math.round((completedSteps / totalSteps) * 100),\r\n    };\r\n  },\r\n});\r\n\r\n/**\r\n * Mark onboarding as complete\r\n *\r\n * Sets onboardingStatus = 'completed' and:\r\n * - If user has active subscription \u2192 accountStatus = 'active'\r\n * - If no subscription (beta/bypass) but BYPASS_PAYMENT \u2192 accountStatus = 'active'\r\n * - Otherwise keeps existing accountStatus\r\n */\r\nexport const markComplete = internalMutation({\r\n  args: {\r\n    userId: v.id('users'),\r\n    bypassPayment: v.optional(v.boolean()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    const user = await ctx.db.get(args.userId);\r\n    if (!user) throw new Error('User not found');\r\n\r\n    // Check if user has active subscription\r\n    const subscription = await ctx.db\r\n      .query('subscriptions')\r\n      .withIndex('by_user', (q) => q.eq('userId', args.userId))\r\n      .first();\r\n\r\n    const hasActiveSubscription = subscription?.status === 'active';\r\n\r\n    // Determine account status:\r\n    // - Active subscription = active\r\n    // - BYPASS_PAYMENT flag = active (for beta)\r\n    // - Neither = keep current status\r\n    const shouldActivate = hasActiveSubscription || args.bypassPayment === true;\r\n\r\n    await ctx.db.patch(args.userId, {\r\n      onboardingStatus: 'completed',\r\n      accountStatus: shouldActivate ? 'active' : user.accountStatus,\r\n      lastActiveAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    // Fire-and-forget HubSpot sync (will skip if no API key)\r\n    ctx.scheduler.runAfter(0, api.integrations.hubspot.syncUserToHubspot, {\r\n      userId: args.userId,\r\n    });\r\n\r\n    console.log(`[Onboarding] Marked complete for ${args.userId}. Active: ${shouldActivate}`);\r\n\r\n    return { success: true, accountStatus: shouldActivate ? 'active' : user.accountStatus };\r\n  },\r\n});\r\n"],
  "mappings": "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",
  "names": ["init_values", "init_api", "updateOnboardingStep", "mutation", "v", "__name", "ctx", "args", "userId", "auth", "user", "currentSteps", "now", "updatedSteps", "orgId", "api", "patchData", "updateMultipleSteps", "step", "value", "updateStep", "internalMutation", "getProgress", "internalQuery", "steps", "requiredSteps", "optionalSteps", "completedRequired", "completedOptional", "totalSteps", "completedSteps", "isComplete", "markComplete", "shouldActivate", "q"]
}
