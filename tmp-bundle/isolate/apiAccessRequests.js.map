{
  "version": 3,
  "sources": ["../convex/apiAccessRequests.ts"],
  "sourcesContent": ["/**\r\n * API Access Requests\r\n *\r\n * CRUD operations for the API access request form (Enterprise lead gen).\r\n * Wires to HubSpot for sales pipeline.\r\n */\r\n\r\nimport { mutation, query } from './_generated/server';\r\nimport { v } from 'convex/values';\r\nimport { api } from './_generated/api';\r\nimport { auth } from './auth';\r\n\r\n// ============================================\r\n// PUBLIC MUTATIONS (Form Submission)\r\n// ============================================\r\n\r\n/**\r\n * Submit an API access request (public form)\r\n */\r\nexport const submitRequest = mutation({\r\n  args: {\r\n    email: v.string(),\r\n    companyName: v.string(),\r\n    contactName: v.optional(v.string()),\r\n    useCase: v.string(),\r\n    useCaseDetails: v.optional(v.string()),\r\n    expectedMonthlyVolume: v.string(),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n\r\n    // Check if request already exists for this email\r\n    const existing = await ctx.db\r\n      .query('apiAccessRequests')\r\n      .withIndex('by_email', (q) => q.eq('email', args.email))\r\n      .first();\r\n\r\n    if (existing) {\r\n      // Update existing request instead of creating duplicate\r\n      await ctx.db.patch(existing._id, {\r\n        companyName: args.companyName,\r\n        contactName: args.contactName,\r\n        useCase: args.useCase,\r\n        useCaseDetails: args.useCaseDetails,\r\n        expectedMonthlyVolume: args.expectedMonthlyVolume,\r\n        updatedAt: now,\r\n      });\r\n\r\n      // Fire-and-forget HubSpot sync\r\n      ctx.scheduler.runAfter(0, api.integrations.hubspot.syncApiAccessRequest, {\r\n        requestId: existing._id,\r\n      });\r\n\r\n      return { requestId: existing._id, isNew: false };\r\n    }\r\n\r\n    // Create new request\r\n    const requestId = await ctx.db.insert('apiAccessRequests', {\r\n      email: args.email,\r\n      companyName: args.companyName,\r\n      contactName: args.contactName,\r\n      useCase: args.useCase,\r\n      useCaseDetails: args.useCaseDetails,\r\n      expectedMonthlyVolume: args.expectedMonthlyVolume,\r\n      status: 'pending',\r\n      createdAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    // Fire-and-forget HubSpot sync\r\n    ctx.scheduler.runAfter(0, api.integrations.hubspot.syncApiAccessRequest, {\r\n      requestId,\r\n    });\r\n\r\n    return { requestId, isNew: true };\r\n  },\r\n});\r\n\r\n// ============================================\r\n// ADMIN QUERIES\r\n// ============================================\r\n\r\n/**\r\n * List all API access requests (admin only)\r\n */\r\nexport const listRequests = query({\r\n  args: {\r\n    status: v.optional(\r\n      v.union(\r\n        v.literal('pending'),\r\n        v.literal('approved'),\r\n        v.literal('rejected'),\r\n        v.literal('contacted')\r\n      )\r\n    ),\r\n    limit: v.optional(v.number()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // TODO: Add admin role check when auth is available\r\n\r\n    if (args.status) {\r\n      const requests = await ctx.db\r\n        .query('apiAccessRequests')\r\n        .withIndex('by_status', (q) => q.eq('status', args.status!))\r\n        .order('desc')\r\n        .take(args.limit ?? 50);\r\n      return requests;\r\n    }\r\n\r\n    const requests = await ctx.db\r\n      .query('apiAccessRequests')\r\n      .order('desc')\r\n      .take(args.limit ?? 50);\r\n\r\n    return requests;\r\n  },\r\n});\r\n\r\n/**\r\n * Get a single API access request by ID\r\n */\r\nexport const getRequest = query({\r\n  args: { requestId: v.id('apiAccessRequests') },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db.get(args.requestId);\r\n  },\r\n});\r\n\r\n// ============================================\r\n// ADMIN MUTATIONS\r\n// ============================================\r\n\r\n/**\r\n * Approve an API access request (generates API key)\r\n */\r\nexport const approveRequest = mutation({\r\n  args: {\r\n    requestId: v.id('apiAccessRequests'),\r\n    adminNotes: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const adminId = await auth.getUserId(ctx);\r\n    if (!adminId) throw new Error('Unauthorized');\r\n\r\n    // TODO: Check admin role\r\n\r\n    const request = await ctx.db.get(args.requestId);\r\n    if (!request) throw new Error('Request not found');\r\n\r\n    if (request.status === 'approved') {\r\n      return { success: false, reason: 'already_approved' };\r\n    }\r\n\r\n    const now = Date.now();\r\n\r\n    // Update request status\r\n    await ctx.db.patch(args.requestId, {\r\n      status: 'approved',\r\n      adminNotes: args.adminNotes,\r\n      reviewedBy: adminId,\r\n      reviewedAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    // TODO: Generate API key and link to request\r\n    // TODO: Send approval email notification\r\n\r\n    // Fire-and-forget HubSpot sync (update status)\r\n    ctx.scheduler.runAfter(0, api.integrations.hubspot.syncApiAccessRequest, {\r\n      requestId: args.requestId,\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n\r\n/**\r\n * Reject an API access request\r\n */\r\nexport const rejectRequest = mutation({\r\n  args: {\r\n    requestId: v.id('apiAccessRequests'),\r\n    adminNotes: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const adminId = await auth.getUserId(ctx);\r\n    if (!adminId) throw new Error('Unauthorized');\r\n\r\n    const now = Date.now();\r\n\r\n    await ctx.db.patch(args.requestId, {\r\n      status: 'rejected',\r\n      adminNotes: args.adminNotes,\r\n      reviewedBy: adminId,\r\n      reviewedAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    // Fire-and-forget HubSpot sync\r\n    ctx.scheduler.runAfter(0, api.integrations.hubspot.syncApiAccessRequest, {\r\n      requestId: args.requestId,\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n\r\n/**\r\n * Mark request as contacted (sales reached out)\r\n */\r\nexport const markContacted = mutation({\r\n  args: {\r\n    requestId: v.id('apiAccessRequests'),\r\n    adminNotes: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const adminId = await auth.getUserId(ctx);\r\n    if (!adminId) throw new Error('Unauthorized');\r\n\r\n    const now = Date.now();\r\n\r\n    await ctx.db.patch(args.requestId, {\r\n      status: 'contacted',\r\n      adminNotes: args.adminNotes,\r\n      reviewedBy: adminId,\r\n      reviewedAt: now,\r\n      updatedAt: now,\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n\r\n/**\r\n * Update HubSpot sync status (internal, called by HubSpot action)\r\n */\r\nexport const updateHubspotSync = mutation({\r\n  args: {\r\n    requestId: v.id('apiAccessRequests'),\r\n    hubspotContactId: v.string(),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.patch(args.requestId, {\r\n      hubspotContactId: args.hubspotContactId,\r\n      hubspotSyncedAt: Date.now(),\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n"],
  "mappings": "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",
  "names": ["init_values", "init_api", "submitRequest", "mutation", "v", "__name", "ctx", "args", "now", "existing", "q", "api", "requestId", "listRequests", "query", "getRequest", "approveRequest", "adminId", "auth", "request", "rejectRequest", "markContacted", "updateHubspotSync"]
}
