{
  "version": 3,
  "sources": ["../convex/users.ts"],
  "sourcesContent": ["import { query, mutation } from './_generated/server';\r\nimport { v } from 'convex/values';\r\nimport { auth } from './auth';\r\nimport { checkAdminRole } from './lib/rbac';\r\n\r\n/**\r\n * Filter user object to safe fields only.\r\n * Rule: Never return more data than the UI requires.\r\n */\r\nfunction filterUserFields(user: any) {\r\n  return {\r\n    _id: user._id,\r\n    name: user.name,\r\n    email: user.email,\r\n    role: user.role,\r\n    createdAt: user.createdAt ?? user._creationTime,\r\n    onboardingStatus: user.onboardingStatus,\r\n  };\r\n}\r\n\r\n/**\r\n * Get the currently logged-in user's data.\r\n *\r\n * Naming Convention:\r\n * - `me` = logged-in user (this query)\r\n * - `identity` = auth session (auth.getUserId)\r\n * - `user` = other users (getById for admins)\r\n */\r\nexport const me = query({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const userId = await auth.getUserId(ctx);\r\n    if (userId === null) {\r\n      return null;\r\n    }\r\n    const user = await ctx.db.get(userId);\r\n    if (!user) return null;\r\n\r\n    // Return safe fields only - never expose passwordHash\r\n    return {\r\n      _id: user._id,\r\n      name: user.name,\r\n      email: user.email,\r\n      image: user.image,\r\n      role: user.role,\r\n      membershipTier: user.membershipTier,\r\n      createdAt: user.createdAt ?? user._creationTime,\r\n      onboardingStatus: user.onboardingStatus,\r\n      onboardingSteps: user.onboardingSteps,\r\n      // Boolean flag for password (never return actual hash)\r\n      hasPassword: !!user.passwordHash,\r\n    };\r\n  },\r\n});\r\n\r\n// Alias for backward compatibility - some components use api.users.current\r\nexport const current = me;\r\n\r\nexport const completeOnboarding = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const userId = await auth.getUserId(ctx);\r\n    if (userId === null) {\r\n      throw new Error('Not authenticated');\r\n    }\r\n\r\n    // Get user to check if beta user\r\n    const user = await ctx.db.get(userId);\r\n    const now = Date.now();\r\n\r\n    // For beta users, set betaExpiresAt to 6 months from now\r\n    const SIX_MONTHS_MS = 6 * 30 * 24 * 60 * 60 * 1000;\r\n    const updatePayload: {\r\n      onboardingStatus: 'completed';\r\n      betaExpiresAt?: number;\r\n    } = {\r\n      onboardingStatus: 'completed',\r\n    };\r\n\r\n    if (user?.isBetaUser && !user.betaExpiresAt) {\r\n      updatePayload.betaExpiresAt = now + SIX_MONTHS_MS;\r\n    }\r\n\r\n    await ctx.db.patch(userId, updatePayload);\r\n  },\r\n});\r\n\r\nexport const resetOnboarding = mutation({\r\n  args: { userId: v.id('users') },\r\n  handler: async (ctx, args) => {\r\n    const viewerId = await auth.getUserId(ctx);\r\n    if (viewerId === null) {\r\n      throw new Error('Not authenticated');\r\n    }\r\n    const viewer = await ctx.db.get(viewerId);\r\n    if (!viewer || (viewer.role !== 'admin' && viewer.role !== 'super_admin')) {\r\n      throw new Error('Unauthorized: Admin access required');\r\n    }\r\n    await ctx.db.patch(args.userId, { onboardingStatus: 'in_progress' });\r\n  },\r\n});\r\n\r\n/**\r\n * Get user by ID\r\n * Security: Users can only get their own data, admins can get any user.\r\n */\r\nexport const getById = query({\r\n  args: { userId: v.id('users') },\r\n  handler: async (ctx, args) => {\r\n    const callerId = await auth.getUserId(ctx);\r\n    if (!callerId) {\r\n      throw new Error('Unauthorized: Not logged in');\r\n    }\r\n\r\n    const user = await ctx.db.get(args.userId);\r\n    if (!user) return null;\r\n\r\n    // Allow if requesting own data\r\n    if (callerId === args.userId) {\r\n      return filterUserFields(user);\r\n    }\r\n\r\n    // Allow if caller is admin\r\n    const isAdmin = await checkAdminRole(ctx, 'admin');\r\n    if (isAdmin) {\r\n      return filterUserFields(user);\r\n    }\r\n\r\n    // Otherwise, deny access\r\n    throw new Error('Forbidden: Cannot access other users data');\r\n  },\r\n});\r\n\r\n/**\r\n * List all users (admin only, for bulk operations)\r\n * Security: Requires admin role, returns filtered fields only.\r\n */\r\nexport const listAll = query({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const userId = await auth.getUserId(ctx);\r\n    if (!userId) {\r\n      return [];\r\n    }\r\n\r\n    const user = await ctx.db.get(userId);\r\n    if (!user || (user.role !== 'admin' && user.role !== 'super_admin')) {\r\n      return [];\r\n    }\r\n\r\n    const users = await ctx.db.query('users').collect();\r\n    return users.map(filterUserFields);\r\n  },\r\n});\r\n"],
  "mappings": "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",
  "names": ["init_values", "filterUserFields", "user", "__name", "me", "query", "ctx", "userId", "auth", "current", "completeOnboarding", "mutation", "now", "SIX_MONTHS_MS", "updatePayload", "resetOnboarding", "v", "args", "viewerId", "viewer", "getById", "callerId", "checkAdminRole", "listAll"]
}
