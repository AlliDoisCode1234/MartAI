{
  "version": 3,
  "sources": ["../convex/admin.ts"],
  "sourcesContent": ["import { query } from './_generated/server';\r\nimport { v } from 'convex/values';\r\nimport { requireAdmin } from './lib/rbac';\r\n\r\n/**\r\n * Filter user object to safe fields only.\r\n * Rule: Never return more data than the UI requires.\r\n */\r\nfunction filterUserFields(user: any) {\r\n  return {\r\n    _id: user._id,\r\n    name: user.name,\r\n    email: user.email,\r\n    role: user.role,\r\n    createdAt: user.createdAt ?? user._creationTime,\r\n    onboardingStatus: user.onboardingStatus,\r\n  };\r\n}\r\n\r\n// Get all users with their subscription details (Admin only)\r\nexport const getAllUsers = query({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    // Security: Require admin role\r\n    await requireAdmin(ctx);\r\n\r\n    const users = await ctx.db.query('users').order('desc').collect();\r\n\r\n    // Enrich with subscription info, filter to safe fields\r\n    const usersWithDetails = await Promise.all(\r\n      users.map(async (user) => {\r\n        const subscription = await ctx.db\r\n          .query('subscriptions')\r\n          .withIndex('by_user', (q) => q.eq('userId', user._id))\r\n          .first();\r\n\r\n        return {\r\n          ...filterUserFields(user),\r\n          subscription: subscription\r\n            ? {\r\n                planTier: subscription.planTier,\r\n                status: subscription.status,\r\n              }\r\n            : null,\r\n        };\r\n      })\r\n    );\r\n\r\n    return usersWithDetails;\r\n  },\r\n});\r\n\r\n// Get a single user with details (Admin only)\r\nexport const getUser = query({\r\n  args: { userId: v.id('users') },\r\n  handler: async (ctx, args) => {\r\n    // Security: Require admin role\r\n    await requireAdmin(ctx);\r\n\r\n    const user = await ctx.db.get(args.userId);\r\n    if (!user) return null;\r\n\r\n    const subscription = await ctx.db\r\n      .query('subscriptions')\r\n      .withIndex('by_user', (q) => q.eq('userId', user._id))\r\n      .first();\r\n\r\n    return {\r\n      ...filterUserFields(user),\r\n      subscription: subscription\r\n        ? {\r\n            planTier: subscription.planTier,\r\n            status: subscription.status,\r\n          }\r\n        : null,\r\n    };\r\n  },\r\n});\r\n\r\n// Get all keywords across the system (Admin only)\r\nexport const getAllKeywords = query({\r\n  args: { limit: v.optional(v.number()) },\r\n  handler: async (ctx, args) => {\r\n    // Security: Require admin role\r\n    await requireAdmin(ctx);\r\n\r\n    const limit = args.limit ?? 100;\r\n    const keywords = await ctx.db.query('keywords').order('desc').take(limit);\r\n\r\n    // Enrich with client name\r\n    const keywordsWithClient = await Promise.all(\r\n      keywords.map(async (kw) => {\r\n        const project = kw.projectId ? await ctx.db.get(kw.projectId) : null;\r\n        return {\r\n          ...kw,\r\n          clientName: project?.name || 'Unknown Project',\r\n        };\r\n      })\r\n    );\r\n\r\n    return keywordsWithClient;\r\n  },\r\n});\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AACAA;AAOA,SAASC,EAAiBC,GAAW;AACnC,SAAO;AAAA,IACL,KAAKA,EAAK;AAAA,IACV,MAAMA,EAAK;AAAA,IACX,OAAOA,EAAK;AAAA,IACZ,MAAMA,EAAK;AAAA,IACX,WAAWA,EAAK,aAAaA,EAAK;AAAA,IAClC,kBAAkBA,EAAK;AAAA,EACzB;AACF;AATSC,EAAAF,GAAA;AAYF,IAAMG,IAAcC,EAAM;AAAA,EAC/B,MAAM,CAAC;AAAA,EACP,SAAS,gBAAAF,EAAA,OAAOG,MAAQ;AAEtB,UAAMC,EAAaD,CAAG;AAEtB,QAAME,IAAQ,MAAMF,EAAI,GAAG,MAAM,OAAO,EAAE,MAAM,MAAM,EAAE,QAAQ;AAsBhE,WAnByB,MAAM,QAAQ;AAAA,MACrCE,EAAM,IAAI,OAAON,MAAS;AACxB,YAAMO,IAAe,MAAMH,EAAI,GAC5B,MAAM,eAAe,EACrB,UAAU,WAAW,CAACI,MAAMA,EAAE,GAAG,UAAUR,EAAK,GAAG,CAAC,EACpD,MAAM;AAET,eAAO;AAAA,UACL,GAAGD,EAAiBC,CAAI;AAAA,UACxB,cAAcO,IACV;AAAA,YACE,UAAUA,EAAa;AAAA,YACvB,QAAQA,EAAa;AAAA,UACvB,IACA;AAAA,QACN;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EAGF,GA3BS;AA4BX,CAAC,GAGYE,IAAUN,EAAM;AAAA,EAC3B,MAAM,EAAE,QAAQO,EAAE,GAAG,OAAO,EAAE;AAAA,EAC9B,SAAS,gBAAAT,EAAA,OAAOG,GAAKO,MAAS;AAE5B,UAAMN,EAAaD,CAAG;AAEtB,QAAMJ,IAAO,MAAMI,EAAI,GAAG,IAAIO,EAAK,MAAM;AACzC,QAAI,CAACX,EAAM,QAAO;AAElB,QAAMO,IAAe,MAAMH,EAAI,GAC5B,MAAM,eAAe,EACrB,UAAU,WAAW,CAACI,MAAMA,EAAE,GAAG,UAAUR,EAAK,GAAG,CAAC,EACpD,MAAM;AAET,WAAO;AAAA,MACL,GAAGD,EAAiBC,CAAI;AAAA,MACxB,cAAcO,IACV;AAAA,QACE,UAAUA,EAAa;AAAA,QACvB,QAAQA,EAAa;AAAA,MACvB,IACA;AAAA,IACN;AAAA,EACF,GArBS;AAsBX,CAAC,GAGYK,IAAiBT,EAAM;AAAA,EAClC,MAAM,EAAE,OAAOO,EAAE,SAASA,EAAE,OAAO,CAAC,EAAE;AAAA,EACtC,SAAS,gBAAAT,EAAA,OAAOG,GAAKO,MAAS;AAE5B,UAAMN,EAAaD,CAAG;AAEtB,QAAMS,IAAQF,EAAK,SAAS,KACtBG,IAAW,MAAMV,EAAI,GAAG,MAAM,UAAU,EAAE,MAAM,MAAM,EAAE,KAAKS,CAAK;AAaxE,WAV2B,MAAM,QAAQ;AAAA,MACvCC,EAAS,IAAI,OAAOC,MAAO;AACzB,YAAMC,IAAUD,EAAG,YAAY,MAAMX,EAAI,GAAG,IAAIW,EAAG,SAAS,IAAI;AAChE,eAAO;AAAA,UACL,GAAGA;AAAA,UACH,YAAYC,GAAS,QAAQ;AAAA,QAC/B;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EAGF,GAnBS;AAoBX,CAAC;",
  "names": ["init_values", "filterUserFields", "user", "__name", "getAllUsers", "query", "ctx", "requireAdmin", "users", "subscription", "q", "getUser", "v", "args", "getAllKeywords", "limit", "keywords", "kw", "project"]
}
